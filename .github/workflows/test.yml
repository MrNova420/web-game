name: Comprehensive Testing & QA

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Client Testing
  client-test:
    name: Client Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json
      
      - name: Install Dependencies
        working-directory: ./client
        run: npm ci
      
      - name: Run ESLint
        working-directory: ./client
        run: npm run lint || true
      
      - name: Run Type Check
        working-directory: ./client
        run: npm run type-check || true
      
      - name: Run Unit Tests
        working-directory: ./client
        run: npm run test:run
      
      - name: Run Integration Tests
        working-directory: ./client
        run: npm run test:run -- integration/ || true
      
      - name: Run Stress Tests
        working-directory: ./client
        run: npm run test:run -- stress/ || true
      
      - name: Build Client
        working-directory: ./client
        run: npm run build
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: client-build
          path: client/dist
          retention-days: 7

  # Server Testing
  server-test:
    name: Server Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
      
      - name: Install Dependencies
        working-directory: ./server
        run: npm ci
      
      - name: Run ESLint
        working-directory: ./server
        run: npm run lint || true
      
      - name: Run Type Check
        working-directory: ./server
        run: npm run type-check
      
      - name: Run Unit Tests
        working-directory: ./server
        run: npm run test:run
      
      - name: Build Server
        working-directory: ./server
        run: npm run build
      
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: server-build
          path: server/dist
          retention-days: 7

  # Code Quality
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install Client Dependencies
        working-directory: ./client
        run: npm ci
      
      - name: Check Bundle Size
        working-directory: ./client
        run: |
          npm run build
          BUNDLE_SIZE=$(du -sb dist | cut -f1)
          echo "Bundle size: $BUNDLE_SIZE bytes"
          if [ $BUNDLE_SIZE -gt 2000000 ]; then
            echo "Warning: Bundle size exceeds 2MB"
          fi

  # Security Audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Audit Client Dependencies
        working-directory: ./client
        run: npm audit --audit-level=moderate || true
      
      - name: Audit Server Dependencies
        working-directory: ./server
        run: npm audit --audit-level=moderate || true

  # Performance Testing
  performance-test:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [client-test, server-test]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install Client Dependencies
        working-directory: ./client
        run: npm ci
      
      - name: Download Client Build
        uses: actions/download-artifact@v3
        with:
          name: client-build
          path: client/dist
      
      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x
      
      - name: Run Lighthouse CI
        working-directory: ./client
        run: |
          npx serve -s dist -l 3000 &
          sleep 5
          lhci autorun --collect.url=http://localhost:3000 || true

  # Test Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [client-test, server-test, code-quality, security-audit]
    if: always()
    
    steps:
      - name: Test Summary
        run: |
          echo "==================================="
          echo "      TEST SUITE SUMMARY"
          echo "==================================="
          echo "Client Tests: ${{ needs.client-test.result }}"
          echo "Server Tests: ${{ needs.server-test.result }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Security Audit: ${{ needs.security-audit.result }}"
          echo "==================================="
